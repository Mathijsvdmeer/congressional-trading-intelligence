<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Congressional Trading Intelligence | Track US Congress Stock Trades</title>
    <meta name="description" content="Real-time tracking of US Congressional stock trades. See what politicians are buying and selling. Optimised for Australian investors.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            min-height: 100vh;
            padding: 20px;
            color: #e2e8f0;
        }

        .container {
            max-width: 1500px;
            margin: 0 auto;
        }

        /* â”€â”€â”€ HEADER â”€â”€â”€ */
        header {
            background: rgba(255,255,255,0.07);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            padding: 22px 30px;
            border-radius: 16px;
            margin-bottom: 24px;
        }

        .header__top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 14px;
        }

        .header__brand h1 {
            font-size: 24px;
            font-weight: 800;
            color: #fff;
            letter-spacing: -0.5px;
        }

        .header__brand .subtitle {
            color: rgba(255,255,255,0.55);
            font-size: 13px;
            margin-top: 3px;
        }

        .header__actions {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 9px 18px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
            text-decoration: none;
        }

        .btn-ghost {
            background: rgba(255,255,255,0.08);
            color: #e2e8f0;
            border: 1px solid rgba(255,255,255,0.15);
        }
        .btn-ghost:hover { background: rgba(255,255,255,0.14); }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #fff;
            box-shadow: 0 4px 15px rgba(102,126,234,0.4);
        }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(102,126,234,0.5); }

        /* Currency toggle */
        .currency-toggle {
            display: flex;
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 10px;
            overflow: hidden;
        }

        .currency-toggle button {
            padding: 9px 16px;
            background: transparent;
            border: none;
            color: rgba(255,255,255,0.6);
            font-family: inherit;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .currency-toggle button.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #fff;
        }

        .fx-rate {
            font-size: 11px;
            color: rgba(255,255,255,0.35);
            margin-top: 3px;
            text-align: right;
        }

        /* â”€â”€â”€ STATS â”€â”€â”€ */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.1);
            padding: 20px 22px;
            border-radius: 14px;
            transition: transform 0.2s;
        }
        .stat-card:hover { transform: translateY(-2px); }

        .stat-value {
            font-size: 32px;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea, #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1;
            margin-bottom: 6px;
        }

        .stat-label {
            color: rgba(255,255,255,0.5);
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        /* â”€â”€â”€ FILTERS â”€â”€â”€ */
        .filters {
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.1);
            padding: 20px 24px;
            border-radius: 14px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 14px;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .filter-group label {
            color: rgba(255,255,255,0.55);
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .filter-group input,
        .filter-group select {
            padding: 10px 12px;
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 9px;
            font-size: 13px;
            font-family: inherit;
            color: #e2e8f0;
            transition: all 0.2s;
        }
        .filter-group input::placeholder { color: rgba(255,255,255,0.3); }
        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(102,126,234,0.1);
        }
        .filter-group select option { background: #302b63; color: #e2e8f0; }

        .stake-filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
            padding-bottom: 2px;
        }
        .stake-filter-group input[type="checkbox"] {
            width: 15px;
            height: 15px;
            accent-color: #667eea;
            cursor: pointer;
        }
        .stake-filter-group label {
            font-size: 13px;
            font-weight: 600;
            color: rgba(255,255,255,0.7);
            cursor: pointer;
            text-transform: none;
            letter-spacing: 0;
        }

        /* Trade count pill */
        .trade-count-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(102,126,234,0.15);
            border: 1px solid rgba(102,126,234,0.3);
            border-radius: 20px;
            padding: 6px 14px;
            font-size: 12px;
            font-weight: 600;
            color: #a5b4fc;
            white-space: nowrap;
            align-self: flex-end;
        }

        /* â”€â”€â”€ TABLE CONTAINER â”€â”€â”€ */
        .trades-container {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.09);
            border-radius: 14px;
            overflow: hidden;
            position: relative;
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: rgba(255,255,255,0.4);
            font-size: 15px;
        }

        .loading::before {
            content: '';
            display: block;
            width: 36px;
            height: 36px;
            border: 3px solid rgba(102,126,234,0.3);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .error-msg {
            background: rgba(239,68,68,0.1);
            border: 1px solid rgba(239,68,68,0.3);
            color: #fca5a5;
            padding: 20px 24px;
            border-radius: 10px;
            margin: 20px;
        }

        /* â”€â”€â”€ TABLE â”€â”€â”€ */
        .table-wrapper {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: rgba(255,255,255,0.04);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        th {
            padding: 13px 14px;
            text-align: left;
            color: rgba(255,255,255,0.45);
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.7px;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
            transition: color 0.2s;
        }
        th:hover { color: rgba(255,255,255,0.8); }
        th.sort-active { color: #818cf8; }

        td {
            padding: 13px 14px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 13px;
            color: #cbd5e1;
            vertical-align: middle;
        }

        tr:last-child td { border-bottom: none; }
        tr:hover td { background: rgba(255,255,255,0.03); }

        /* â”€â”€â”€ AMOUNT BORDER HIERARCHY â”€â”€â”€ */
        /* $1M+ = gold */
        tr.tier-gold td:first-child {
            border-left: 4px solid #FFD700;
        }
        tr.tier-gold .amount-cell {
            color: #FFD700;
            font-weight: 700;
        }

        /* $500K+ = orange */
        tr.tier-orange td:first-child {
            border-left: 4px solid #FF8C00;
        }
        tr.tier-orange .amount-cell {
            color: #fb923c;
            font-weight: 700;
        }

        /* $100K+ = blue */
        tr.tier-blue td:first-child {
            border-left: 4px solid #3B82F6;
        }
        tr.tier-blue .amount-cell {
            color: #818cf8;
            font-weight: 600;
        }

        /* smaller = default */
        .amount-cell {
            font-weight: 500;
            color: rgba(255,255,255,0.5);
            font-size: 13px;
        }

        /* â”€â”€â”€ BADGES â”€â”€â”€ */
        .badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.3px;
        }

        .badge-purchase { background: rgba(16,185,129,0.15); color: #34d399; border: 1px solid rgba(16,185,129,0.3); }
        .badge-sale     { background: rgba(239,68,68,0.15);  color: #f87171; border: 1px solid rgba(239,68,68,0.3); }
        .badge-democrat   { background: rgba(59,130,246,0.15); color: #60a5fa; border: 1px solid rgba(59,130,246,0.25); }
        .badge-republican { background: rgba(239,68,68,0.15);  color: #f87171; border: 1px solid rgba(239,68,68,0.25); }

        .ticker-badge {
            font-weight: 700;
            color: #e2e8f0;
            font-size: 13px;
        }

        .stake-icon {
            font-size: 10px;
            opacity: 0.6;
            margin-left: 3px;
        }

        .politician-link {
            color: #a5b4fc;
            text-decoration: none;
            font-weight: 600;
        }
        .politician-link:hover { color: #c4b5fd; text-decoration: underline; }

        .chamber-small {
            font-size: 11px;
            color: rgba(255,255,255,0.3);
            display: block;
            margin-top: 2px;
        }

        .trade-age {
            font-size: 11px;
            color: rgba(255,255,255,0.35);
        }
        .trade-age.recent { color: #34d399; }
        .trade-age.developing { color: #fbbf24; }

        /* â”€â”€â”€ SIGNAL SCORE â”€â”€â”€ */
        .signal-stars {
            color: #f59e0b;
            font-size: 14px;
            letter-spacing: 1px;
            cursor: help;
            position: relative;
        }
        .signal-stars[data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 130%;
            left: 50%;
            transform: translateX(-50%);
            background: #1e1b4b;
            color: #e2e8f0;
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
            font-size: 12px;
            white-space: normal;
            max-width: 240px;
            text-align: center;
            z-index: 200;
            line-height: 1.4;
        }
        .signal-locked {
            font-size: 14px;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        .signal-locked:hover { opacity: 1; }

        /* â”€â”€â”€ PAYWALL â”€â”€â”€ */
        .paywall-wrapper {
            position: relative;
        }

        tr.blurred td {
            filter: blur(4px);
            user-select: none;
            pointer-events: none;
        }

        .paywall-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to bottom, transparent 0%, rgba(15,12,41,0.6) 30%, rgba(15,12,41,0.97) 65%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            padding: 140px 20px 48px;
            border-radius: 0 0 14px 14px;
            z-index: 10;
        }

        .paywall-content {
            text-align: center;
            max-width: 460px;
        }

        .paywall-content .lock-icon {
            font-size: 36px;
            margin-bottom: 12px;
            display: block;
        }

        .paywall-content h3 {
            font-size: 22px;
            font-weight: 800;
            color: #fff;
            margin-bottom: 6px;
        }

        .paywall-content .paywall-sub {
            color: rgba(255,255,255,0.5);
            font-size: 14px;
            margin-bottom: 20px;
        }

        .paywall-features {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            margin-bottom: 24px;
        }
        .paywall-features span {
            background: rgba(102,126,234,0.15);
            border: 1px solid rgba(102,126,234,0.3);
            color: #a5b4fc;
            padding: 5px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .btn-upgrade {
            display: inline-block;
            padding: 14px 36px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #fff;
            font-size: 15px;
            font-weight: 700;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(102,126,234,0.5);
            transition: all 0.2s;
            text-decoration: none;
        }
        .btn-upgrade:hover { transform: translateY(-2px); box-shadow: 0 12px 30px rgba(102,126,234,0.6); }

        .money-back {
            margin-top: 12px;
            font-size: 12px;
            color: rgba(255,255,255,0.35);
        }

        /* â”€â”€â”€ FOOTER â”€â”€â”€ */
        .footer-disclaimer {
            text-align: center;
            color: rgba(255,255,255,0.3);
            font-size: 11px;
            margin-top: 24px;
            line-height: 1.6;
            padding: 0 20px;
        }

        /* â”€â”€â”€ RESPONSIVE â”€â”€â”€ */
        @media (max-width: 768px) {
            body { padding: 12px; }
            .header__brand h1 { font-size: 18px; }
            td, th { padding: 10px 10px; }
            .filters { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>
<div class="container">

    <!-- â•â•â• HEADER â•â•â• -->
    <header>
        <div class="header__top">
            <div class="header__brand">
                <h1>ğŸ“Š Congressional Trading Intelligence</h1>
                <p class="subtitle">Real-time tracking of US Congressional stock trades Â· Optimised for Australian investors</p>
            </div>
            <div class="header__actions">
                <a href="pricing.html" class="btn btn-ghost">ğŸ’ Pricing</a>
                <a href="pricing.html#insider" id="upgradeBtn" style="display:none;" class="btn btn-primary">â­ Upgrade to Insider</a>
                <a href="auth.html" id="authBtn" class="btn btn-primary">Login / Sign Up</a>
                <button id="signOutBtn" onclick="signOut()" style="display:none;" class="btn btn-ghost" title="Sign out">â†© Sign Out</button>
                <div>
                    <div class="currency-toggle">
                        <button id="btnAUD" class="active" onclick="setCurrency('AUD')">ğŸ‡¦ğŸ‡º AUD</button>
                        <button id="btnUSD" onclick="setCurrency('USD')">ğŸ‡ºğŸ‡¸ USD</button>
                    </div>
                    <div class="fx-rate" id="fxRateLabel">Loading rateâ€¦</div>
                </div>
            </div>
        </div>
    </header>

    <!-- â•â•â• DATA DELAY NOTICE (free tier only) â•â•â• -->
    <div id="delayNotice" style="display:none; align-items:center; gap:12px; background:rgba(251,191,36,0.08); border:1px solid rgba(251,191,36,0.25); border-radius:12px; padding:12px 20px; margin-bottom:16px; font-size:13px; color:#fbbf24;">
        <span>â±</span>
        <span><strong>7-day delayed data.</strong> You're on the free tier â€” trades are shown 7 days after disclosure. <a href="pricing.html" style="color:#fbbf24; font-weight:700; text-decoration:underline;">Upgrade to Insider for real-time â†’</a></span>
    </div>

    <!-- â•â•â• STATS â•â•â• -->
    <div class="stats">
        <div class="stat-card">
            <div class="stat-value" id="totalTrades">â€”</div>
            <div class="stat-label">Total Trades</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="uniquePoliticians">â€”</div>
            <div class="stat-label">Politicians</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="uniqueTickers">â€”</div>
            <div class="stat-label">Stocks Traded</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="recentTrades">Daily</div>
            <div class="stat-label" id="recentLabel">Refresh Rate</div>
        </div>
    </div>

    <!-- â•â•â• FILTERS â•â•â• -->
    <div class="filters">
        <div class="filter-group">
            <label>Search Politician</label>
            <input type="text" id="searchPolitician" placeholder="e.g., Pelosi">
        </div>
        <div class="filter-group">
            <label>Search Ticker</label>
            <input type="text" id="searchTicker" placeholder="e.g., NVDA">
        </div>
        <div class="filter-group">
            <label>Minimum Amount</label>
            <select id="minAmount" onchange="applyFilters()">
                <option value="0">All Trades</option>
                <option value="15000" selected>$15K+ Only â­</option>
                <option value="50000">$50K+ Only</option>
                <option value="100000">$100K+ Only</option>
                <option value="500000">$500K+ Only</option>
                <option value="1000000">$1M+ Only</option>
            </select>
        </div>
        <div class="filter-group">
            <label>Sort By</label>
            <select id="sortBy" onchange="applyFilters()">
                <option value="impact">Impact Score âš¡</option>
                <option value="date">Date (Newest)</option>
                <option value="amount">Amount (Highest)</option>
                <option value="politician">Politician Aâ†’Z</option>
            </select>
        </div>
        <div class="filter-group">
            <label>Trade Type</label>
            <select id="filterTradeType" onchange="applyFilters()">
                <option value="">All Types</option>
                <option value="Purchase">Purchase</option>
                <option value="Sale">Sale</option>
                <option value="Exchange">Exchange</option>
            </select>
        </div>
        <div class="filter-group">
            <label>Party</label>
            <select id="filterParty" onchange="applyFilters()">
                <option value="">All Parties</option>
                <option value="D">Democrat</option>
                <option value="R">Republican</option>
            </select>
        </div>
        <div class="filter-group stake-filter-group">
            <input type="checkbox" id="filterStake" onchange="applyFilters()">
            <label for="filterStake">ğŸ‡¦ğŸ‡º Stake/Pearler only</label>
        </div>
        <div class="trade-count-pill" id="tradeCountPill">
            Loadingâ€¦
        </div>
    </div>

    <!-- â•â•â• TRADES TABLE â•â•â• -->
    <div class="trades-container">
        <div class="loading" id="loading">Loading tradesâ€¦</div>
        <div id="errorMsg" class="error-msg" style="display:none;"></div>

        <div class="paywall-wrapper" id="paywallWrapper">
            <div class="table-wrapper">
                <table id="tradesTable" style="display:none;">
                    <thead>
                        <tr>
                            <th onclick="setSortAndRender('amount')" id="th-amount">Amount â†•</th>
                            <th onclick="setSortAndRender('member_name')" id="th-politician">Politician</th>
                            <th onclick="setSortAndRender('ticker')" id="th-ticker">Ticker</th>
                            <th onclick="setSortAndRender('trade_type')" id="th-type">Type</th>
                            <th onclick="setSortAndRender('trade_date')" id="th-date">Date</th>
                            <th onclick="setSortAndRender('party')" id="th-party">Party</th>
                            <th title="Historical pattern analysis based on trade volume and disclosure timing. Factual information only â€” not financial advice.">Pattern â„¹ï¸</th>
                        </tr>
                    </thead>
                    <tbody id="tradesBody"></tbody>
                </table>
            </div>

            <!-- Paywall overlay â€” shown for free users -->
            <div class="paywall-overlay" id="paywallOverlay" style="display:none;">
                <div class="paywall-content">
                    <span class="lock-icon">ğŸ”’</span>
                    <h3>Unlock <span id="paywallCount">1,990+</span> More Trades</h3>
                    <p class="paywall-sub" id="paywallSub">You're viewing the 10 highest-impact trades. Real-time data starts at A$19.99/mo.</p>
                    <div class="paywall-features">
                        <span>âœ“ 109K+ Trades (2012â€“now)</span>
                        <span>âœ“ Real-time, no 7-day delay</span>
                        <span>âœ“ Signal Score â­â­â­â­â­</span>
                        <span>âœ“ Email Alerts</span>
                        <span>âœ“ CSV Export</span>
                    </div>
                    <a href="pricing.html#insider" class="btn-upgrade">Start 7-Day Free Trial â€” A$19.99/mo</a>
                    <p class="money-back">30-day money-back guarantee Â· Cancel anytime Â· No credit card for trial</p>
                </div>
            </div>
        </div>
    </div>

    <p class="footer-disclaimer">
        This is factual information only, not financial advice. Past performance is not indicative of future results.<br>
        Congressional trade disclosures are public record sourced from the STOCK Act. Data provided for informational purposes only.
    </p>
</div>

<script>
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CONFIG
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    const API_URL = 'https://congress-trader-api-production.up.railway.app';

    // High-profile politicians (30 pts bonus for impact score)
    const HIGH_PROFILE = new Set([
        'nancy pelosi', 'tommy tuberville', 'dan crenshaw',
        'josh gottheimer', 'marjorie taylor greene', 'michael t. mccaul',
        'paul pelosi', 'mark green', 'ro khanna', 'brian mast',
        'alan lowenthal', 'virginia foxx'
    ]);

    // Tickers tradeable on Stake/Pearler (AU)
    const STAKE_TICKERS = new Set([
        'AAPL','MSFT','GOOGL','GOOG','AMZN','META','NVDA','AMD','TSLA','NFLX',
        'INTC','QCOM','CRM','ORCL','CSCO','IBM','ADBE','PYPL','UBER','SHOP',
        'JPM','GS','BAC','V','MA','C','WFC','MS','BRK.B','AXP','BLK','SCHW',
        'JNJ','PFE','MRK','ABBV','UNH','CVS','AMGN','GILD','LLY','ABT',
        'XOM','CVX','COP','SLB','OXY',
        'WMT','COST','TGT','MCD','SBUX','KO','PEP','DIS','CMCSA','NKE',
        'LMT','RTX','NOC','BA','GD',
        'PLTR','COIN','SQ','SNAP','SPOT','RBLX'
    ]);

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       STATE
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    let allTrades = [];
    let filteredTrades = [];
    let signalScores = {};
    let currentSort = 'impact';
    let currentCurrency = localStorage.getItem('currency') || 'AUD';
    let usdToAud = 1.58;

    let userTier = localStorage.getItem('user_tier') || 'free';
    const FREE_LIMIT = 10;

    // On load: if we have a stored token, verify it against the API and update tier
    async function syncUserTier() {
        const token = localStorage.getItem('supabase_token');
        if (!token) return;
        try {
            const r = await fetch(`${API_URL}/account`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (r.status === 401) {
                // Token expired â€” clear session
                localStorage.removeItem('supabase_token');
                localStorage.removeItem('user_email');
                localStorage.removeItem('user_tier');
                return;
            }
            if (!r.ok) return;
            const data = await r.json();
            const tier  = data.user?.subscription_tier || 'free';
            const email = data.user?.email;
            userTier = tier;
            localStorage.setItem('user_tier', tier);
            if (email) localStorage.setItem('user_email', email); // fill in if missing (e.g. post email-verify)
            updateAuthUI();
            renderTrades(); // re-render with correct tier
        } catch { /* non-critical */ }
    }

    function updateAuthUI() {
        const email = localStorage.getItem('user_email');
        const btn = document.getElementById('authBtn');
        const signOutBtn = document.getElementById('signOutBtn');
        const upgradeBtn = document.getElementById('upgradeBtn');
        if (email) {
            const tierLabel = { free: 'Free', insider: 'Insider â­', elite: 'Elite ğŸ‘‘' }[userTier] || 'Free';
            btn.textContent = `ğŸ‘¤ ${email.split('@')[0]} Â· ${tierLabel}`;
            btn.href = 'auth.html';
            if (signOutBtn) signOutBtn.style.display = 'inline-flex';
            // Show upgrade CTA only for free logged-in users
            if (upgradeBtn) upgradeBtn.style.display = userTier === 'free' ? 'inline-flex' : 'none';
        } else {
            btn.textContent = 'Login / Sign Up';
            btn.href = 'auth.html';
            if (signOutBtn) signOutBtn.style.display = 'none';
            if (upgradeBtn) upgradeBtn.style.display = 'none';
        }
        // Show/hide the data delay notice
        const notice = document.getElementById('delayNotice');
        if (notice) {
            notice.style.display = userTier === 'free' ? 'flex' : 'none';
        }
    }

    function signOut() {
        localStorage.removeItem('user_email');
        localStorage.removeItem('supabase_token');
        localStorage.removeItem('user_tier');
        localStorage.removeItem('intended_plan');
        userTier = 'free';
        updateAuthUI();
        renderTrades();
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       IMPACT SCORE
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    function calcImpactScore(trade) {
        let score = 0;
        const amount = trade.amount_low || 0;

        // Amount weight (50 pts max)
        if      (amount >= 1000000) score += 50;
        else if (amount >= 500000)  score += 40;
        else if (amount >= 100000)  score += 30;
        else if (amount >= 50000)   score += 20;
        else                        score += 10;

        // Politician importance (30 pts max)
        if (HIGH_PROFILE.has((trade.member_name || '').toLowerCase())) score += 30;

        // Recency (20 pts max)
        const daysAgo = trade.trade_date
            ? Math.floor((Date.now() - new Date(trade.trade_date + 'T00:00:00')) / 86400000)
            : 9999;
        if      (daysAgo < 30)  score += 20;
        else if (daysAgo < 90)  score += 15;
        else if (daysAgo < 180) score += 10;
        else                    score += 5;

        return score;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SORT
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    function sortTrades(trades, sortKey) {
        return [...trades].sort((a, b) => {
            switch (sortKey) {
                case 'impact':
                    return (b._impactScore || 0) - (a._impactScore || 0);
                case 'date':
                    return new Date(b.trade_date || 0) - new Date(a.trade_date || 0);
                case 'amount':
                    return (b.amount_low || 0) - (a.amount_low || 0);
                case 'member_name':
                case 'politician':
                    return (a.member_name || '').localeCompare(b.member_name || '');
                case 'ticker':
                    return (a.ticker || '').localeCompare(b.ticker || '');
                case 'trade_type':
                    return (a.trade_type || '').localeCompare(b.trade_type || '');
                case 'party':
                    return (a.party || '').localeCompare(b.party || '');
                default:
                    return 0;
            }
        });
    }

    function setSortAndRender(col) {
        currentSort = col;
        document.getElementById('sortBy').value =
            (['impact','date','amount','politician'].includes(col) ? col : 'impact');
        applyFilters();
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CURRENCY
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    async function loadExchangeRate() {
        try {
            const r = await fetch('https://api.frankfurter.app/latest?from=USD&to=AUD');
            if (!r.ok) throw new Error();
            const d = await r.json();
            usdToAud = d.rates.AUD;
            document.getElementById('fxRateLabel').textContent = `1 USD = ${usdToAud.toFixed(4)} AUD`;
        } catch {
            document.getElementById('fxRateLabel').textContent = `1 USD â‰ˆ ${usdToAud.toFixed(2)} AUD (est.)`;
        }
    }

    function setCurrency(c) {
        currentCurrency = c;
        localStorage.setItem('currency', c);
        document.getElementById('btnAUD').classList.toggle('active', c === 'AUD');
        document.getElementById('btnUSD').classList.toggle('active', c === 'USD');
        renderTrades();
    }

    function formatAmount(usd) {
        if (usd == null || usd === '') return 'â€”';
        const v = currentCurrency === 'AUD' ? Math.round(usd * usdToAud) : Math.round(usd);
        const prefix = currentCurrency === 'AUD' ? 'A$' : '$';
        if (v >= 1000000) return prefix + (v / 1000000).toFixed(1) + 'M';
        if (v >= 1000)    return prefix + (v / 1000).toFixed(0) + 'K';
        return prefix + v.toLocaleString();
    }

    function formatDate(dateStr) {
        if (!dateStr) return 'â€”';
        const d = new Date(dateStr + 'T00:00:00');
        return currentCurrency === 'AUD'
            ? d.toLocaleDateString('en-AU')
            : d.toLocaleDateString('en-US');
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       AMOUNT TIER
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    function getAmountTierClass(amount) {
        if (amount >= 1000000) return 'tier-gold';
        if (amount >= 500000)  return 'tier-orange';
        if (amount >= 100000)  return 'tier-blue';
        return '';
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SIGNAL SCORES
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    async function loadSignalScores() {
        try {
            const r = await fetch(`${API_URL}/signal-scores`);
            if (!r.ok) return;
            const scores = await r.json();
            scores.forEach(s => { signalScores[s.member_name.toLowerCase()] = s; });
        } catch { /* non-critical */ }
    }

    function renderSignalCell(memberName) {
        const isPaid = userTier === 'insider' || userTier === 'elite';
        if (!isPaid) {
            return `<td><span class="signal-locked" onclick="window.location.href='pricing.html'" title="Upgrade to Insider to see Pattern Analysis">ğŸ”’</span></td>`;
        }
        const data = signalScores[(memberName || '').toLowerCase()];
        if (!data) return '<td>â€”</td>';
        const score = data.signal_score || 1;
        const stars = 'â˜…'.repeat(score) + 'â˜†'.repeat(5 - score);
        const lag = data.avg_disclosure_lag_days != null ? `${data.avg_disclosure_lag_days}d avg` : 'N/A';
        const tip = `Based on ${data.trade_count} trades. Avg disclosure lag: ${lag}. Factual info only â€” not financial advice.`;
        return `<td><span class="signal-stars" data-tooltip="${tip}">${stars}</span></td>`;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       STATS
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    async function loadStats() {
        try {
            const r = await fetch(`${API_URL}/stats`);
            if (!r.ok) throw new Error();
            const s = await r.json();
            document.getElementById('totalTrades').textContent      = (s.total_trades || 0).toLocaleString();
            document.getElementById('uniquePoliticians').textContent = (s.unique_politicians || 0).toLocaleString();
            document.getElementById('uniqueTickers').textContent     = (s.unique_tickers || 0).toLocaleString();
            if (s.recent_trades_30d) {
                document.getElementById('recentTrades').textContent = s.recent_trades_30d.toLocaleString();
                document.getElementById('recentLabel').textContent  = 'Trades (30 Days)';
            }
            // else: stays "Daily / Refresh Rate" â€” always looks populated
        } catch { /* fail silently */ }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       LOAD TRADES
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    async function loadTrades(attempt = 1) {
        try {
            const r = await fetch(`${API_URL}/trades?limit=2000`);
            if (!r.ok) throw new Error('Failed to load trades');
            const payload = await r.json();
            // API returns either array or {trades:[...]}
            allTrades = Array.isArray(payload) ? payload : (payload.trades || []);

            // Pre-compute impact scores
            allTrades.forEach(t => { t._impactScore = calcImpactScore(t); });

            document.getElementById('loading').style.display = 'none';
            document.getElementById('tradesTable').style.display = 'table';

            applyFilters();
        } catch (err) {
            // Retry once on network failure (handles Railway cold-start)
            if (attempt === 1 && err.message === 'Failed to fetch') {
                const el = document.getElementById('errorMsg');
                el.style.display = 'block';
                el.textContent = 'Connecting to serverâ€¦ retrying';
                setTimeout(() => loadTrades(2), 4000);
                return;
            }
            document.getElementById('loading').style.display = 'none';
            const el = document.getElementById('errorMsg');
            el.style.display = 'block';
            el.textContent = 'Error loading trades: ' + err.message;
        }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       FILTERS & RENDER
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    let politicianTimer = null;

    function applyFilters() {
        const politician  = document.getElementById('searchPolitician').value.trim();
        const ticker      = document.getElementById('searchTicker').value.trim().toUpperCase();
        const minAmount   = parseInt(document.getElementById('minAmount').value) || 0;
        const tradeType   = document.getElementById('filterTradeType').value;
        const party       = document.getElementById('filterParty').value;
        const stakeOnly   = document.getElementById('filterStake').checked;
        const sortKey     = document.getElementById('sortBy').value;
        currentSort = sortKey;

        // Politician search â†’ API
        if (politician.length >= 2) {
            clearTimeout(politicianTimer);
            politicianTimer = setTimeout(() => {
                searchPoliticianFromAPI(politician, ticker, minAmount, tradeType, party, stakeOnly);
            }, 380);
            return;
        }

        filteredTrades = allTrades.filter(t => {
            const amt = t.amount_low || 0;
            // Normalize party for filter comparison (API returns 'Democratic'/'Republican' or 'D'/'R')
            const tParty = t.party === 'Democratic' ? 'D' : t.party === 'Republican' ? 'R' : (t.party || '');
            if (ticker    && !t.ticker.includes(ticker))            return false;
            if (tradeType && t.trade_type !== tradeType)            return false;
            if (party     && tParty !== party)                      return false;
            if (stakeOnly && !STAKE_TICKERS.has(t.ticker))         return false;
            if (amt < minAmount)                                    return false;
            return true;
        });

        filteredTrades = sortTrades(filteredTrades, sortKey);
        renderTrades();
    }

    async function searchPoliticianFromAPI(name, ticker, minAmount, tradeType, party, stakeOnly) {
        const tbody = document.getElementById('tradesBody');
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:30px;color:rgba(255,255,255,0.4);">Searchingâ€¦</td></tr>';

        try {
            const r = await fetch(`${API_URL}/politician/${encodeURIComponent(name)}/trades`);
            if (!r.ok) throw new Error();
            const data = await r.json();
            let trades = Array.isArray(data) ? data : (data.trades || []);

            trades.forEach(t => { t._impactScore = calcImpactScore(t); });

            filteredTrades = trades.filter(t => {
                const amt    = t.amount_low || 0;
                const tParty = t.party === 'Democratic' ? 'D' : t.party === 'Republican' ? 'R' : (t.party || '');
                if (ticker    && !t.ticker.includes(ticker))     return false;
                if (tradeType && t.trade_type !== tradeType)     return false;
                if (party     && tParty !== party)               return false;
                if (stakeOnly && !STAKE_TICKERS.has(t.ticker))  return false;
                if (amt < minAmount)                             return false;
                return true;
            });

            filteredTrades = sortTrades(filteredTrades, currentSort);
            renderTrades();
        } catch {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:30px;color:rgba(255,255,255,0.4);">No trades found for that politician.</td></tr>';
        }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       RENDER
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    function renderTrades() {
        const tbody = document.getElementById('tradesBody');
        tbody.innerHTML = '';

        const total = filteredTrades.length;
        const showPaywall = userTier === 'free';
        const displayCount = showPaywall ? Math.min(FREE_LIMIT, total) : total;

        // Update trade count pill
        const minAmt = parseInt(document.getElementById('minAmount').value) || 0;
        const minLabel = minAmt ? `$${(minAmt/1000).toFixed(0)}K+` : 'All';
        document.getElementById('tradeCountPill').textContent =
            showPaywall
                ? `Showing ${displayCount} of ${total.toLocaleString()} trades (free tier)`
                : `Showing ${displayCount.toLocaleString()} trades`;

        for (let i = 0; i < total; i++) {
            const trade = filteredTrades[i];
            const row = document.createElement('tr');

            // Amount tier border class
            const tierClass = getAmountTierClass(trade.amount_low || 0);
            if (tierClass) row.classList.add(tierClass);

            // Blur rows beyond free limit
            if (showPaywall && i >= FREE_LIMIT) {
                row.classList.add('blurred');
            }

            const isPurchase = trade.trade_type === 'Purchase';
            // Normalize full party names to codes (API returns both 'D' and 'Democratic')
            const partyCode  = trade.party === 'Democratic' ? 'D' : trade.party === 'Republican' ? 'R' : (trade.party || '');
            const partyBadge = partyCode === 'D' ? 'badge-democrat' : 'badge-republican';
            const partyText  = partyCode === 'D' ? 'DEM' : partyCode === 'R' ? 'GOP' : (partyCode || 'â€”');

            const daysAgo = trade.trade_date
                ? Math.floor((Date.now() - new Date(trade.trade_date + 'T00:00:00')) / 86400000)
                : null;
            const ageClass = daysAgo === null ? '' : daysAgo < 30 ? 'recent' : daysAgo < 90 ? 'developing' : '';
            const ageLabel = daysAgo === null ? 'â€”'
                : daysAgo < 30  ? 'Recent'
                : daysAgo < 90  ? 'Developing'
                : 'Mature';

            const amtLow  = formatAmount(trade.amount_low);
            const amtHigh = formatAmount(trade.amount_high);
            const amtStr  = (amtLow && amtHigh && amtLow !== 'â€”' && amtHigh !== 'â€”')
                ? `${amtLow} â€“ ${amtHigh}`
                : (amtLow !== 'â€”' ? amtLow : 'â€”');

            const stakeIcon = STAKE_TICKERS.has(trade.ticker) ? ' <span class="stake-icon" title="Available on Stake/Pearler">âœ…</span>' : '';

            row.innerHTML = `
                <td class="amount-cell">${amtStr}</td>
                <td>
                    <a href="politician.html?name=${encodeURIComponent(trade.member_name)}" class="politician-link">${trade.member_name || 'â€”'}</a>
                    <span class="chamber-small">${trade.chamber || ''}</span>
                </td>
                <td><span class="ticker-badge">${trade.ticker || 'â€”'}</span>${stakeIcon}</td>
                <td><span class="badge ${isPurchase ? 'badge-purchase' : 'badge-sale'}">${trade.trade_type || 'â€”'}</span></td>
                <td>${formatDate(trade.trade_date)}<br><span class="trade-age ${ageClass}">${ageLabel}</span></td>
                <td><span class="badge ${partyBadge}">${partyText}</span></td>
                ${renderSignalCell(trade.member_name)}
            `;

            tbody.appendChild(row);
        }

        // Show/hide paywall overlay
        const overlay = document.getElementById('paywallOverlay');
        if (showPaywall && total > FREE_LIMIT) {
            overlay.style.display = 'flex';
            document.getElementById('paywallCount').textContent =
                (total - FREE_LIMIT).toLocaleString() + '+';
            document.getElementById('paywallSub').textContent =
                `You're viewing the ${FREE_LIMIT} highest-impact trades of ${total.toLocaleString()} available. Real-time data starts at A$19.99/mo.`;
        } else {
            overlay.style.display = 'none';
        }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       INIT
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    // Apply saved currency immediately
    document.getElementById('btnAUD').classList.toggle('active', currentCurrency === 'AUD');
    document.getElementById('btnUSD').classList.toggle('active', currentCurrency === 'USD');

    // Event listeners
    document.getElementById('searchPolitician').addEventListener('input', applyFilters);
    document.getElementById('searchTicker').addEventListener('input', applyFilters);

    // Handle Supabase email-verification redirect (token arrives in URL hash)
    (function extractHashSession() {
        const hash = window.location.hash;
        if (hash && hash.includes('access_token')) {
            const params = new URLSearchParams(hash.replace('#', '?').replace('#', '&'));
            const token = params.get('access_token');
            if (token) {
                localStorage.setItem('supabase_token', token);
                history.replaceState(null, '', window.location.pathname);
            }
        }
    })();

    // If user signed up intending to upgrade, show a nudge banner
    (function checkIntendedPlan() {
        const plan  = localStorage.getItem('intended_plan');
        const email = localStorage.getItem('user_email') || localStorage.getItem('supabase_token');
        const tier  = localStorage.getItem('user_tier') || 'free';
        if (!plan || !email || tier !== 'free') return;
        const banner = document.createElement('div');
        banner.style.cssText = 'display:flex;align-items:center;gap:12px;background:rgba(102,126,234,0.12);border:1px solid rgba(102,126,234,0.35);border-radius:12px;padding:12px 20px;margin-bottom:16px;font-size:13px;color:#a5b4fc;';
        const planLabel = plan === 'elite' ? 'Elite (A$49/mo)' : 'Insider (A$19.99/mo)';
        banner.innerHTML = `<span>â­</span><span>You selected <strong>${planLabel}</strong>. Payment setup coming shortly â€” <a href="pricing.html" style="color:#a5b4fc;font-weight:700;text-decoration:underline;">view plan details â†’</a></span><button onclick="this.parentElement.remove();localStorage.removeItem('intended_plan');" style="margin-left:auto;background:none;border:none;color:rgba(255,255,255,0.3);cursor:pointer;font-size:18px;line-height:1;">Ã—</button>`;
        const statsEl = document.querySelector('.stats');
        if (statsEl) statsEl.parentNode.insertBefore(banner, statsEl);
    })();

    // Initial auth UI from localStorage (instant, no network)
    updateAuthUI();

    // Boot: load everything in parallel, then verify session in background
    loadExchangeRate();
    loadStats();
    loadSignalScores();
    loadTrades().then(() => syncUserTier()); // sync tier after trades load so re-render is correct
</script>
</body>
</html>
