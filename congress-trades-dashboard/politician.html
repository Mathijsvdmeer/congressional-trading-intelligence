<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Politician Profile ‚Äî Congressional Trading Intelligence</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container { max-width: 1200px; margin: 0 auto; }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: rgba(255,255,255,0.85);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 20px;
            transition: color 0.2s;
        }
        .back-link:hover { color: white; }

        /* Profile card */
        .profile-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 25px;
            flex-wrap: wrap;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: 700;
            color: white;
            flex-shrink: 0;
        }
        .profile-avatar--dem { background: linear-gradient(135deg, #4299e1, #2b6cb0); }
        .profile-avatar--rep { background: linear-gradient(135deg, #fc8181, #c53030); }
        .profile-avatar--ind { background: linear-gradient(135deg, #68d391, #276749); }

        .profile-info { flex: 1; min-width: 200px; }
        .profile-info h1 { color: #2d3748; font-size: 26px; margin-bottom: 8px; }

        .profile-badges { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 6px; }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .badge-dem { background: #bee3f8; color: #2c5282; }
        .badge-rep { background: #fed7d7; color: #742a2a; }
        .badge-ind { background: #c6f6d5; color: #22543d; }
        .badge-chamber { background: #e9d8fd; color: #553c9a; }
        .badge-purchase { background: #c6f6d5; color: #22543d; }
        .badge-sale { background: #fed7d7; color: #742a2a; }

        .profile-signal { margin-left: auto; text-align: center; }
        .profile-signal .stars { font-size: 22px; color: #f6c90e; letter-spacing: 2px; }
        .profile-signal .stars-label { font-size: 11px; color: #a0aec0; margin-top: 3px; }
        .profile-signal .locked { font-size: 22px; cursor: pointer; }

        /* Stats row */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            text-align: center;
        }
        .stat-card__value {
            font-size: 28px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 4px;
        }
        .stat-card__label {
            font-size: 12px;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Tabs */
        .tabs-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .tabs-nav {
            display: flex;
            border-bottom: 2px solid #e2e8f0;
            background: #f7fafc;
        }

        .tab-btn {
            padding: 15px 25px;
            font-size: 14px;
            font-weight: 600;
            color: #718096;
            background: none;
            border: none;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
        }
        .tab-btn:hover { color: #667eea; }
        .tab-btn--active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: white;
        }

        .tab-panel { display: none; padding: 25px; }
        .tab-panel--active { display: block; }

        /* Trades table */
        table { width: 100%; border-collapse: collapse; }
        thead { background: #f7fafc; }
        th {
            padding: 12px 15px;
            text-align: left;
            color: #4a5568;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #e2e8f0;
            color: #2d3748;
            font-size: 14px;
        }
        tr:last-child td { border-bottom: none; }
        tr.row--purchase { background: rgba(16,185,129,0.04); border-left: 3px solid rgba(16,185,129,0.4); }
        tr.row--sale { background: rgba(239,68,68,0.04); border-left: 3px solid rgba(239,68,68,0.3); }

        .amount { font-weight: 600; color: #667eea; }

        /* Ticker chips */
        .tickers-section {
            background: white;
            border-radius: 15px;
            padding: 20px 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 25px;
        }
        .tickers-section h3 { color: #4a5568; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; }
        .ticker-chips { display: flex; flex-wrap: wrap; gap: 8px; }
        .ticker-chip {
            background: #edf2f7;
            color: #4a5568;
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
        }
        .ticker-chip--stake { background: #c6f6d5; color: #22543d; }

        /* Chart container */
        .chart-wrapper { position: relative; height: 320px; }

        .loading { text-align: center; padding: 60px; color: #718096; }
        .error { background: #fed7d7; color: #742a2a; padding: 20px; border-radius: 8px; }

        .stake-badge { font-size: 11px; margin-left: 4px; }

        @media (max-width: 600px) {
            .profile-card { flex-direction: column; text-align: center; }
            .profile-badges { justify-content: center; }
            .profile-signal { margin: 0 auto; }
        }
    </style>
</head>
<body>
<div class="container">

    <a href="index.html" class="back-link">‚Üê Back to Dashboard</a>

    <div id="loading" class="loading" style="background:white;border-radius:15px;">Loading profile...</div>
    <div id="error" class="error" style="display:none;"></div>

    <!-- Profile card ‚Äî hidden until loaded -->
    <div id="profileCard" class="profile-card" style="display:none;">
        <div id="avatar" class="profile-avatar"></div>
        <div class="profile-info">
            <h1 id="profileName">-</h1>
            <div class="profile-badges" id="profileBadges"></div>
            <div style="font-size:13px;color:#718096;" id="profileState"></div>
        </div>
        <div class="profile-signal" id="profileSignal"></div>
    </div>

    <div id="statsGrid" class="stats-grid" style="display:none;"></div>

    <div id="tickersSection" class="tickers-section" style="display:none;">
        <h3>Most Traded Stocks</h3>
        <div class="ticker-chips" id="tickerChips"></div>
    </div>

    <div id="tabsContainer" class="tabs-container" style="display:none;">
        <div class="tabs-nav">
            <button class="tab-btn tab-btn--active" onclick="switchTab('trades')">Recent Trades</button>
            <button class="tab-btn" onclick="switchTab('chart')">Activity Chart</button>
        </div>

        <div id="tab-trades" class="tab-panel tab-panel--active">
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Ticker</th>
                        <th>Company</th>
                        <th>Type</th>
                        <th>Amount</th>
                        <th>Disclosed</th>
                    </tr>
                </thead>
                <tbody id="tradesBody"></tbody>
            </table>
        </div>

        <div id="tab-chart" class="tab-panel">
            <div class="chart-wrapper">
                <canvas id="activityChart"></canvas>
            </div>
        </div>
    </div>

    <p style="text-align:center;color:rgba(255,255,255,0.7);font-size:12px;margin-top:25px;padding:0 20px;">
        This is factual information only, not financial advice. Past performance is not indicative of future results.
        Congressional trade disclosures are public record sourced from the STOCK Act.
    </p>

</div>

<script>
    const API_URL = 'https://congress-trader-api-production.up.railway.app';

    // Tickers available on Stake/Pearler (matches main dashboard list)
    const STAKE_TICKERS = new Set([
        'AAPL','MSFT','GOOGL','GOOG','AMZN','META','NVDA','AMD','TSLA','NFLX',
        'INTC','QCOM','CRM','ORCL','CSCO','IBM','ADBE','PYPL','UBER','SHOP',
        'JPM','GS','BAC','V','MA','C','WFC','MS','BRK.B','AXP','BLK','SCHW',
        'JNJ','PFE','MRK','ABBV','UNH','CVS','AMGN','GILD','LLY','ABT',
        'XOM','CVX','COP','SLB','OXY',
        'WMT','COST','TGT','MCD','SBUX','KO','PEP','DIS','CMCSA','NKE',
        'LMT','RTX','NOC','BA','GD',
        'PLTR','COIN','SQ','SNAP','SPOT','RBLX'
    ]);

    // Currency helpers (match main dashboard)
    let currentCurrency = localStorage.getItem('currency') || 'AUD';
    let usdToAud = 1.58;

    function formatAmount(v) {
        if (!v && v !== 0) return '-';
        if (currentCurrency === 'AUD') return 'A$' + Math.round(v * usdToAud).toLocaleString();
        return '$' + Math.round(v).toLocaleString();
    }

    function formatDate(s) {
        if (!s) return '-';
        const d = new Date(s + 'T00:00:00');
        return currentCurrency === 'AUD' ? d.toLocaleDateString('en-AU') : d.toLocaleDateString('en-US');
    }

    // Get name from URL param
    const params = new URLSearchParams(window.location.search);
    const rawName = params.get('name') || '';

    if (!rawName) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').style.display = 'block';
        document.getElementById('error').textContent = 'No politician specified. Go back and click a politician name.';
    } else {
        loadProfile(rawName);
    }

    async function loadProfile(name) {
        try {
            // Fetch stats + trade history in parallel
            const [statsRes, tradesRes, rateRes] = await Promise.allSettled([
                fetch(`${API_URL}/politician/${encodeURIComponent(name)}`),
                fetch(`${API_URL}/politician/${encodeURIComponent(name)}/trades`),
                fetch('https://api.frankfurter.app/latest?from=USD&to=AUD')
            ]);

            // Apply live FX rate if available
            if (rateRes.status === 'fulfilled' && rateRes.value.ok) {
                const fx = await rateRes.value.json();
                usdToAud = fx.rates.AUD;
            }

            if (statsRes.status !== 'fulfilled' || !statsRes.value.ok) {
                throw new Error('Could not load politician data');
            }

            const stats = await statsRes.value.json();
            const allTrades = tradesRes.status === 'fulfilled' && tradesRes.value.ok
                ? await tradesRes.value.json()
                : stats.recent_trades || [];

            renderProfile(stats, allTrades);

        } catch (e) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('error').textContent = 'Error loading profile: ' + e.message;
        }
    }

    function renderProfile(stats, allTrades) {
        document.getElementById('loading').style.display = 'none';

        const party = stats.party || '';
        const initials = stats.politician.split(' ').map(w => w[0]).filter(Boolean).slice(0,2).join('');
        const avatarClass = party === 'D' ? 'profile-avatar--dem' : party === 'R' ? 'profile-avatar--rep' : 'profile-avatar--ind';
        const badgeClass = party === 'D' ? 'badge-dem' : party === 'R' ? 'badge-rep' : 'badge-ind';
        const partyLabel = party === 'D' ? 'Democrat' : party === 'R' ? 'Republican' : party || 'Independent';

        // Avatar
        const avatar = document.getElementById('avatar');
        avatar.textContent = initials;
        avatar.className = `profile-avatar ${avatarClass}`;

        // Name & badges
        document.getElementById('profileName').textContent = stats.politician;
        document.title = `${stats.politician} ‚Äî Congressional Trading Intelligence`;
        const badgesEl = document.getElementById('profileBadges');
        badgesEl.innerHTML = `
            <span class="badge ${badgeClass}">${partyLabel}</span>
            ${stats.chamber ? `<span class="badge badge-chamber">${stats.chamber}</span>` : ''}
        `;
        if (stats.state) document.getElementById('profileState').textContent = stats.state;

        // Signal score
        loadSignalScore(stats.politician);

        // Stats cards
        const buyRatio = stats.total_trades > 0
            ? Math.round((stats.purchases / stats.total_trades) * 100)
            : 0;
        const topTicker = stats.tickers && stats.tickers.length > 0 ? stats.tickers[0] : '-';

        document.getElementById('statsGrid').innerHTML = `
            <div class="stat-card">
                <div class="stat-card__value">${stats.total_trades.toLocaleString()}</div>
                <div class="stat-card__label">Total Trades</div>
            </div>
            <div class="stat-card">
                <div class="stat-card__value">${stats.purchases.toLocaleString()}</div>
                <div class="stat-card__label">Purchases</div>
            </div>
            <div class="stat-card">
                <div class="stat-card__value">${stats.sales.toLocaleString()}</div>
                <div class="stat-card__label">Sales</div>
            </div>
            <div class="stat-card">
                <div class="stat-card__value">${buyRatio}%</div>
                <div class="stat-card__label">Buy Ratio</div>
            </div>
            <div class="stat-card">
                <div class="stat-card__value">${stats.unique_tickers}</div>
                <div class="stat-card__label">Unique Stocks</div>
            </div>
        `;

        // Ticker chips (top 15)
        const topTickers = (stats.tickers || []).slice(0, 15);
        document.getElementById('tickerChips').innerHTML = topTickers.map(t =>
            `<span class="ticker-chip ${STAKE_TICKERS.has(t) ? 'ticker-chip--stake' : ''}" title="${STAKE_TICKERS.has(t) ? '‚úÖ Available on Stake/Pearler' : '‚ùå Not on Stake/Pearler'}">${t}</span>`
        ).join('');

        // Trades table (recent 20)
        const recentTrades = allTrades.slice(0, 20);
        const tbody = document.getElementById('tradesBody');
        tbody.innerHTML = recentTrades.map(t => {
            const isPurchase = t.trade_type === 'Purchase';
            const rowClass = isPurchase ? 'row--purchase' : 'row--sale';
            const badgeCls = isPurchase ? 'badge-purchase' : 'badge-sale';
            const stakeBadge = STAKE_TICKERS.has(t.ticker)
                ? '<span class="stake-badge" title="Available on Stake/Pearler">‚úÖ</span>'
                : '';
            const amtLow = formatAmount(t.amount_low);
            const amtHigh = formatAmount(t.amount_high);
            const lagDays = t.disclosure_date && t.trade_date
                ? Math.round((new Date(t.disclosure_date) - new Date(t.trade_date)) / 86400000)
                : null;
            const lagText = lagDays !== null ? `${lagDays}d lag` : '-';
            return `<tr class="${rowClass}">
                <td>${formatDate(t.trade_date)}</td>
                <td><strong>${t.ticker}</strong>${stakeBadge}</td>
                <td>${t.company_name || '-'}</td>
                <td><span class="badge ${badgeCls}">${t.trade_type}</span></td>
                <td class="amount">${amtLow} ‚Äì ${amtHigh}</td>
                <td style="font-size:12px;color:#a0aec0;">${lagText}</td>
            </tr>`;
        }).join('');

        // Build chart
        buildChart(allTrades);

        // Show all sections
        document.getElementById('profileCard').style.display = 'flex';
        document.getElementById('statsGrid').style.display = 'grid';
        document.getElementById('tickerChips').parentElement.style.display = 'block';
        document.getElementById('tabsContainer').style.display = 'block';
    }

    async function loadSignalScore(name) {
        const userTier = localStorage.getItem('user_tier');
        const isPaid = userTier === 'insider' || userTier === 'elite';
        const el = document.getElementById('profileSignal');

        if (!isPaid) {
            el.innerHTML = `<div class="locked" onclick="alert('Upgrade to Insider to unlock Historical Pattern Analysis')" title="Upgrade to unlock">üîí</div><div class="stars-label">Pattern Score</div>`;
            return;
        }

        try {
            const res = await fetch(`${API_URL}/politician/${encodeURIComponent(name)}/signal-score`);
            if (!res.ok) return;
            const data = await res.json();
            const score = data.signal_score || 1;
            const stars = '‚òÖ'.repeat(score) + '‚òÜ'.repeat(5 - score);
            const lag = data.avg_disclosure_lag_days != null ? `${data.avg_disclosure_lag_days}d avg lag` : '';
            el.innerHTML = `
                <div class="stars" title="${data.trade_count} trades. ${lag}. Factual information only.">${stars}</div>
                <div class="stars-label">Pattern Score</div>
            `;
        } catch (e) { /* non-critical */ }
    }

    function buildChart(trades) {
        // Group by year-month, count buys vs sells
        const months = {};
        trades.forEach(t => {
            if (!t.trade_date) return;
            const ym = t.trade_date.slice(0, 7); // "2024-03"
            if (!months[ym]) months[ym] = { buys: 0, sells: 0 };
            if (t.trade_type === 'Purchase') months[ym].buys++;
            else months[ym].sells++;
        });

        const labels = Object.keys(months).sort().slice(-24); // last 24 months
        const buys = labels.map(m => months[m].buys);
        const sells = labels.map(m => months[m].sells);

        new Chart(document.getElementById('activityChart'), {
            type: 'bar',
            data: {
                labels: labels.map(l => {
                    const [y, m] = l.split('-');
                    return `${new Date(y, m-1).toLocaleString('default', {month:'short'})} ${y.slice(2)}`;
                }),
                datasets: [
                    {
                        label: 'Purchases',
                        data: buys,
                        backgroundColor: 'rgba(16,185,129,0.7)',
                        borderRadius: 3
                    },
                    {
                        label: 'Sales',
                        data: sells,
                        backgroundColor: 'rgba(239,68,68,0.65)',
                        borderRadius: 3
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' },
                    tooltip: {
                        callbacks: {
                            footer: () => 'Factual information only ‚Äî not financial advice'
                        }
                    }
                },
                scales: {
                    x: { stacked: false, grid: { display: false } },
                    y: { beginAtZero: true, ticks: { precision: 0 } }
                }
            }
        });
    }

    function switchTab(tab) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('tab-btn--active'));
        document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('tab-panel--active'));
        document.getElementById(`tab-${tab}`).classList.add('tab-panel--active');
        event.target.classList.add('tab-btn--active');
    }
</script>
</body>
</html>
